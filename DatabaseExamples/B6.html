<!doctype html>
<html>
    <head>
        <title>Database Parsons Problem</title>
        <link href="../parsons.css" rel="stylesheet" />
        <link href="../lib/prettify.css" rel="stylesheet" />
        <script src="../lib/prettify.js"></script>
    </head>
    <body>
        <h2>B6 Database Parsons Problem</h2>
        <p>Construct a query by drag and dropping and reordering lines from the
            left to the right.</p>
        <p>List the names of actors who have acted a role as himself or herself. Sort the results according to surname, and then according to first name, both in ascending order.</p>
        <div>
            <div>
              <h3>Table 1</h3>
              <img src="Pictures/B6.PNG" alt="Table 1">
            </div>
        </div>
        <div id="sortableTrash" class="sortable-code"></div>
        <div id="sortable" class="sortable-code"></div>
        <div style="clear:both;"></div>
        <p>
            <a href="#" id="newInstanceLink">New instance</a>
            <a href="#" id="feedbackLink">Check Solution</a>
            <a href="#" id="nextQuestion" style="float: right;">Next Question</a>
        </p>
        <xmp id="mut"></xmp>
        <script src="../lib/jquery.min.js"></script>
        <script src="../lib/jquery-ui.min.js"></script>
        <script src="../lib/jquery.ui.touch-punch.min.js"></script>
        <script src="../lib/underscore-min.js"></script>
        <script src="../lib/lis.js"></script>
        <script src="../parsons.js"></script>
        <script src ="../mutants.js"></script>
        <script>
        var initial = 'SELECT a.fname, a.sname\n' +
                      'FROM actor a\n' +
                      'WHERE EXISTS\n' +
                      '  (SELECT *\n' +
                      '  FROM acts ac\n' +
                      '  WHERE a.actno = ac.actno\n' +
                      '  AND EXISTS\n' +
                      '     (SELECT *\n' +
                      '     FROM role r\n' +
                      '     WHERE ac.rolno = r.rolno\n' +
                      '     AND (r.alias = "Himself" OR r.alias = "Herself"))\n' +
                      '  )\n' +
                      'ORDER BY a.sname ASC, a.fname ASC;\n'
                      /*Remove Old Example Distractors
                      'SELECT fname sname #distractor\n' +
                      'FROM role a #distractor\n' +
                      '  (SELECT r.fname, r.sname #distractor\n' +
                      '  FROM #distractor\n' +
                      '  SELECT fname sname #distractor\n'*/
        
        function displayErrors(fb) {
            if(fb.errors.length > 0) {
                alert(fb.errors[0]);
            }
        } 

    //NOTE TO SELF ONLY TRUE/FALSE is broken
    $(document).ready(function(){  
            
        console.log("here");

        //Regex Fixes for wildcard and brackets
        var re = new RegExp(/\( SELECT \*/);
        var reOriginal = "( SELECT *";

        var re2 = new RegExp(/\( SELECT \*/);
        var reOriginal2 = "( SELECT *";

        //This is due to and not working so added bracket at the end
        var re3 = new RegExp(/WHERE ac.rolno = r.rolno \)/);
        var reOriginal3 = "WHERE ac.rolno = r.rolno )";

        var re4 = new RegExp(/  \)/);
        var reOriginal4 = "  )";

        var forComparison = ['SELECT a.fname , a.sname','FROM actor a','WHERE EXISTS' ,'FROM acts ac', 'WHERE  a.actno = ac.actno', 'AND EXISTS','FROM role r', 'ORDER BY  a.sname ASC ,  a.fname ASC'];

        let url = 'http://in2test.lsi.uniovi.es/sqlmutation/api/v2/mutants.xml';
        let xhr = new XMLHttpRequest();

        //Connect to rest API
        xhr.open("POST", url);
        let parser = new DOMParser();

        //Data to send to API
        //Note AND (r.alias = "Himself" OR r.alias = "Herself")) doesn't work
        var body = "<b>" + "<sql> SELECT a.fname, a.sname" +
            ' FROM actor a\n' +
            ' WHERE EXISTS\n' +
            '  (SELECT *\n' +
            '  FROM acts ac\n' +
            '  WHERE a.actno = ac.actno\n' +
            '  AND EXISTS\n' +
            '     (SELECT *\n' +
            '     FROM role r\n' +
            '     WHERE ac.rolno = r.rolno)\n' +
            '  )\n' +
            'ORDER BY a.sname ASC, a.fname ASC;\n' + "</sql>" + 
            "<schema>" + 
            "<table name='actor'>"+
            '<column name="actno" type="int"/>'+    
            '<column name="fname" type="varchar"/>'+
            '<column name="sname" type="varchar"/>'+
            '<column name="dob" type="date"/>'+
            '<column name="dod" type="date"/>'+
            '<column name="picture" type="blob"/>'+
            "</table>" +
            "<table name='acts'>"+
            '<column name="actno" type="int"/>'+
            '<column name="movno" type="int"/>'+
            '<column name="rolno" type="int"/>'+
            '<column name="description" type="text"/>'+
            "</table>" +
            "<table name='role'>"+
            '<column name="rolno" type="int"/>'+
            '<column name="fname" type="varchar"/>'+
            '<column name="sname" type="varchar"/>'+
            '<column name="alias" type="varchar"/>'+
            '<column name="description" type="text"/>'+
            "</table>" +
            "</schema>" + 
            "<options>hideids=true,getparsedsql=true</options>"+
            "</b>";

        //Convert String to XML
        let xmlDoc = parser.parseFromString(body, "application/xml");

        //Send to API
        xhr.send(body);


        //On response of API
        xhr.onload = function() {
            
            let parser = new DOMParser();
            let xmlDoc = parser.parseFromString(xhr.responseText, "application/xml");
            let ele = document.getElementById('mut');
            txt = "";

            //Get SQL code from response        
            x = xmlDoc.getElementsByTagName("sql");
            for (i=1; i < x.length; i++){
                txt+= x[i].childNodes[0].nodeValue + "\n";
            }

            //Add Mutant SQL code to webpage
            ele.innerHTML += "Mutants Full Query from API:"+ "\n";
            ele.innerHTML += txt;

            //Loop through mutants and add to array
            var mutantsArray = [];
            for (i=0; i < x.length; i++){
                mutantsArray[i] = x[i].childNodes[0].nodeValue;
            }

            //I loop through and remove lines that are unchanged, so that I can get the changed part of the mutant
            //Loop through mutants array
            for (i=1; i < x.length; i++){
                console.log(mutantsArray[i])


                //Loop through SQL lines
                for (j=0; j < forComparison.length; j++){
                    
                    //Look for match in mutant
                    compareResult = mutantsArray[i].search(forComparison[j]);

                    //Check if line is found
                    if (compareResult!=-1){
                        //Take off match from mutant
                        mutantsArray[i] = mutantsArray[i].slice(0,compareResult) + mutantsArray[i].slice(compareResult + forComparison[j].length) 
                    }
                }

                //Loop through regex could refactor
                for (k=0; k < 1; k++){
                    compareResult = mutantsArray[i].search(re);

                    if (compareResult!=-1){
                        mutantsArray[i] = mutantsArray[i].slice(0,compareResult)+ mutantsArray[i].slice(compareResult + reOriginal.length)
                    }

                    compareResult = mutantsArray[i].search(re2);

                    if (compareResult!=-1){
                        mutantsArray[i] = mutantsArray[i].slice(0,compareResult)+ mutantsArray[i].slice(compareResult + reOriginal2.length)
                    }

                    compareResult = mutantsArray[i].search(re3);

                    if (compareResult!=-1){
                        mutantsArray[i] = mutantsArray[i].slice(0,compareResult)+ mutantsArray[i].slice(compareResult + reOriginal3.length) 
                    }

                    compareResult = mutantsArray[i].search(re4);

                    if (compareResult!=-1){
                        mutantsArray[i] = mutantsArray[i].slice(0,compareResult)+ mutantsArray[i].slice(compareResult + reOriginal4.length)
                    }
                }
            }

            ele.innerHTML += "New Mutants" + "\n";
            for (i=1; i < mutantsArray.length; i++){
                ele.innerHTML += mutantsArray[i] + "\n";
                initial += mutantsArray[i] + "\n";
            }

            var parson = new ParsonsWidget({
                'sortableId': 'sortable',
                'trashId': 'sortableTrash',
                //Used to show amount of distractors shown at once
                'max_wrong_lines': 12,
                // Not adding 'displayErrors' will show a pop up with your error
                'feedback_cb' : displayErrors,
                //Use to show either the first error or all the wrong lines
                'first_error_only': true,
                'incorrectSound': true,
                'droppableType': true,
                'colored_keyword': false,
                'colored_background': true
            });
            parson.init(initial);
            parson.shuffleLines();
            $("#newInstanceLink").click(function(event){
                event.preventDefault();
                parson.shuffleLines();
            });
            $("#feedbackLink").click(function(event){
                event.preventDefault();
                parson.getFeedback();
            });
            $("#nextQuestion").click(function(event){
                location.href='a1.html'
            });

            //Add Accordian Functionality
            var acc = document.getElementsByClassName("accordion");
            var i;
            console.log(acc.length)

            for (i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                /* Toggle between adding and removing the "active" class,
                to highlight the button that controls the panel */
                this.classList.toggle("active");

                /* Toggle between hiding and showing the active panel */
                var panel = this.nextElementSibling;
                if (panel.style.display === "block") {
                panel.style.display = "none";
                } else {
                panel.style.display = "block";
                }
            });
            }
        }
        });

        </script>
        </body>
</html>